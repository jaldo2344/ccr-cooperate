<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Compras - CCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js para gerar som -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .notification {
            animation: slide-in 0.5s forwards, slide-out 0.5s 6.5s forwards;
        }
        @keyframes slide-in {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slide-out {
            from { transform: translateX(0); }
            to { transform: translateX(120%); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="notification-area" class="fixed top-5 right-5 z-50 space-y-3">
        <!-- Notificações visuais aparecerão aqui -->
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">Painel de Administração</h1>
                <p class="text-slate-400">Pedidos de pagamento pendentes.</p>
            </div>
            <button id="activate-sound-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">
                ATIVAR SOM
            </button>
        </header>

        <main id="requests-container">
            <div id="loading-state" class="text-center py-10">
                <p class="text-slate-400">Aguardando novos pedidos...</p>
            </div>
        </main>
    </div>

    <!-- WebSocket Logic -->
    <script type="module">
        const requestsContainer = document.getElementById('requests-container');
        const loadingState = document.getElementById('loading-state');
        const notificationArea = document.getElementById('notification-area');
        const activateSoundBtn = document.getElementById('activate-sound-btn');
        let isSoundActivated = false;
        let synth;

        // Ativa o áudio após a primeira interação do usuário
        activateSoundBtn.addEventListener('click', async () => {
            if (!isSoundActivated) {
                try {
                    await Tone.start();
                    synth = new Tone.Synth({
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                    }).toDestination();
                    // Aumenta o volume. O valor 10 representa um ganho de 10 decibéis.
                    synth.volume.value = 10; 
                    isSoundActivated = true;
                    activateSoundBtn.textContent = 'SOM ATIVADO';
                    activateSoundBtn.classList.remove('bg-red-600', 'hover:bg-red-500');
                    activateSoundBtn.classList.add('bg-green-600', 'cursor-not-allowed');
                    activateSoundBtn.disabled = true;
                    console.log('Contexto de áudio iniciado. Som ativado.');
                } catch (e) {
                    console.error("Erro ao iniciar o áudio:", e);
                    alert("Não foi possível iniciar o áudio. Por favor, interaja com a página e tente novamente.");
                }
            }
        });

        function playNotificationSound() {
            if (isSoundActivated && synth) {
                // Toca uma nota aguda (C6) para o alerta
                synth.triggerAttackRelease("C6", "0.5");
            }
        }
        
        function showNotification(request) {
            const notification = document.createElement('div');
            notification.className = 'notification bg-sky-500 text-white p-4 rounded-lg shadow-lg w-80';
            notification.innerHTML = `
                <h3 class="font-bold">Novo Pedido Recebido!</h3>
                <p>Cliente: ${request.userName}</p>
                <p>Valor: R$ ${request.amount.toFixed(2).replace('.', ',')}</p>
            `;
            notificationArea.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 7000);
        }

        // --- Conexão WebSocket ---
        // IMPORTANTE: Substitua 'your-render-app-url.onrender.com' pelo URL do seu serviço no Render
        const wsUrl = `wss://your-render-app-url.onrender.com`;
        let ws;

        function connectWebSocket() {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Painel conectado ao servidor WebSocket.');
                // Envia uma mensagem para se identificar como painel
                ws.send(JSON.stringify({ type: 'admin_panel_connected' }));
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'new_payment_request') {
                    addRequestToPanel(message.data);
                    playNotificationSound();
                    showNotification(message.data);
                }
            };
            
            ws.onclose = () => {
                console.log('Desconectado. Tentando reconectar em 5 segundos...');
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('Erro no WebSocket do Painel:', error);
                ws.close();
            };
        }

        function addRequestToPanel(request) {
            if (loadingState) {
                loadingState.classList.add('hidden');
            }
            const cardId = `request-${request.requestId}`;

            // Evita adicionar pedidos duplicados
            if (document.getElementById(cardId)) return;

            const requestCard = document.createElement('div');
            requestCard.className = 'bg-slate-800 p-6 rounded-lg shadow-lg mb-4 border border-slate-700';
            requestCard.id = cardId;
            
            const formattedDate = new Date().toLocaleString('pt-BR');

            requestCard.innerHTML = `
                <div class="flex flex-wrap justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-white">${request.userName}</h2>
                        <p class="text-sm text-slate-400">${request.userEmail || 'email@naoinformado.com'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-sky-400">R$ ${request.amount.toFixed(2).replace('.', ',')}</p>
                        <p class="text-xs text-slate-500">Pedido em: ${formattedDate}</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <label for="pix-input-${request.requestId}" class="text-sm font-medium text-slate-300">Inserir Chave PIX Copia e Cola:</label>
                    <div class="flex gap-2">
                        <input type="text" id="pix-input-${request.requestId}" class="w-full bg-slate-700 border-slate-600 text-white rounded-md focus:ring-sky-500 focus:border-sky-500 p-2" placeholder="Cole a chave PIX aqui...">
                        <button data-id="${request.requestId}" class="respond-btn bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-md transition-colors">Responder</button>
                    </div>
                </div>
            `;
            requestsContainer.prepend(requestCard); // Adiciona no topo
        }

        requestsContainer.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('respond-btn')) {
                const requestId = e.target.dataset.id;
                
                const pixInput = document.getElementById(`pix-input-${requestId}`);
                const pixKey = pixInput.value.trim();

                if (!pixKey) {
                    alert('Por favor, insira uma chave PIX.');
                    return;
                }

                const responsePayload = {
                    type: 'pix_response',
                    requestId: requestId,
                    pixKey: pixKey
                };

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(responsePayload));
                    document.getElementById(`request-${requestId}`).remove();
                    if (requestsContainer.children.length === 1 && loadingState) { 
                        loadingState.classList.remove('hidden');
                    }
                } else {
                    alert('Não foi possível enviar a resposta. Verifique a conexão.');
                }
            }
        });

        connectWebSocket();
    </script>
</body>
</html>
